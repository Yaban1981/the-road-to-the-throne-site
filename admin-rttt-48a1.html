<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QHC Admin ‚Äî The Road to The Throne</title>
  <meta name="description" content="Admin QHC: importer les r√©ponses, composer les lineups et exporter JSON (sans base de donn√©es)." />
  <!-- Open Graph / Twitter (pr√©visualisation avec engrenage) -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yaban1981.github.io/the-road-to-the-throne-site/admin-rttt-48a1.html">
  <meta property="og:title" content="QHC Admin ‚Äî The Road to The Throne">
  <meta property="og:description" content="Interface coach (sans DB) pour pr√©parer les lineups QHC.">
  <meta property="og:image" content="https://yaban1981.github.io/the-road-to-the-throne-site/logos/gear.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="QHC Admin ‚Äî The Road to The Throne">
  <meta name="twitter:description" content="Interface coach (sans DB) pour pr√©parer les lineups QHC.">
  <meta name="twitter:image" content="https://yaban1981.github.io/the-road-to-the-throne-site/logos/gear.png">
  <link rel="icon" href="logos/gear.png">
  <style>
    :root{--bg:#0f172a;--panel:#0e152a;--panel2:#0a1020;--text:#e7ecf3;--muted:#a7b3c7;--accent:#d4af37;--accent2:#3b82f6;--ring:rgba(59,130,246,.3);--radius:14px}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(900px 500px at 10% -10%,#0b2451 0,transparent 60%),linear-gradient(180deg,#0a1020,#0b1222);color:var(--text)}
    header{padding:18px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;gap:10px;align-items:center}
    h1{margin:0;font-size:1.35rem}
    main{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:linear-gradient(180deg,var(--panel2),var(--panel));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:0 8px 28px rgba(0,0,0,.35);padding:16px;margin:12px 0}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    textarea,input,select,button{font:inherit;color:var(--text)}
    textarea,input[type=file],input[type=text],select{width:100%;background:#0b1020;border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:10px;outline:none;transition:.2s}
    textarea:focus,input:focus,select:focus{border-color:var(--accent2);box-shadow:0 0 0 3px var(--ring)}
    textarea{min-height:120px;resize:vertical}
    .btn{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(59,130,246,.28)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:#e7ecf3;box-shadow:none}
    .muted{color:var(--muted);font-size:.9rem}
    .grid{display:grid;gap:12px}
    @media(min-width:990px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}
    table{width:100%;border-collapse:collapse;font-size:.95rem}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 6px;vertical-align:top}
    th{color:#cfe1ff;text-align:left}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:.8rem;border:1px solid rgba(255,255,255,.15)}
    .DEF{background:#0b2a3c;border-color:#124b6b}.FWD{background:#3a2a0b;border-color:#6b5312}.CEN{background:#3a300b;border-color:#6b5e12}.GOL{background:#27272a;border-color:#52525b}
    .rowflex{display:flex;gap:8px;flex-wrap:wrap}
    .slot{border:1px dashed rgba(255,255,255,.18);border-radius:12px;padding:10px;min-height:60px;background:rgba(255,255,255,.03)}
    .slotHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;background:#0b1020;border:1px solid rgba(255,255,255,.18)}
    .chip .x{cursor:pointer;opacity:.85}
    .dnd-drag{opacity:.6}
    /* drop highlight */
    .slot.drop-ok{outline:2px solid var(--accent2);outline-offset:2px}
    /* drag area */
    .dropzone{border:2px dashed rgba(255,255,255,.18);border-radius:12px;padding:12px;text-align:center}
  </style>
</head>
<body>
<header>
  <img src="logos/gear.png" alt="admin" style="width:28px;height:28px;border-radius:6px">
  <h1>QHC Admin ‚Äî The Road to The Throne</h1>
  <span class="muted">sans DB ‚Ä¢ GitHub JSON</span>
</header>
<main>

  <!-- Import / Load -->
  <section class="card">
    <h2>1) Importer des joueurs</h2>
    <div class="grid grid-2">
      <div>
        <label>Coller des emails FormSubmit (format ‚ÄúName / Value‚Äù)</label>
        <textarea id="taEmails" placeholder="Colle ici un ou plusieurs emails FormSubmit‚Ä¶"></textarea>
        <div class="bar">
          <button class="btn" id="btnParse">‚ûï Parser & Ajouter</button>
          <button class="btn ghost" id="btnClear">Effacer</button>
        </div>

        <div class="dropzone" id="dz">
          Drag & drop **CSV/JSON** ici (players.json ou export CSV)‚Ä¶<br>
          <span class="muted">Astuce: depuis Outlook, exporte en CSV puis d√©pose.</span>
        </div>
      </div>
      <div>
        <label>Charger depuis le site (fetch)</label>
        <div class="bar">
          <input type="text" id="fetchUrl" value="data/players.json" />
          <button class="btn" id="btnFetch">üîÑ Charger /data/players.json</button>
        </div>
        <label>Charger un fichier local</label>
        <input type="file" id="filePlayers" accept=".json,.csv,text/csv,application/json" />
        <div class="bar">
          <button class="btn" id="btnExportPlayers">üíæ Exporter players.json</button>
          <button class="btn" id="btnExportLineups">üíæ Exporter lineups.json</button>
        </div>
        <div class="muted">Remets ces fichiers dans <code>/data/</code> du repo pour partager aux coachs.</div>
      </div>
    </div>
  </section>

  <!-- Players table -->
  <section class="card">
    <h2>2) Joueurs</h2>
    <div class="bar">
      <input id="q" type="text" placeholder="Recherche (nom/ville)..." style="max-width:260px">
      <select id="fPos">
        <option value="">Position (toutes)</option>
        <option>DEF</option><option>FWD</option><option>CEN</option><option>GOL</option>
      </select>
      <select id="fAvail">
        <option value="">Tournoi (Yes)</option>
        <option value="boston">Boston</option>
        <option value="meltdown">Meltdown</option>
        <option value="throne">Throne</option>
      </select>
      <select id="fConf">
        <option value="">Confiance</option>
        <option value="80">‚â•80%</option><option value="90">‚â•90%</option>
      </select>
    </div>
    <div style="max-height:360px;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:10px">
      <table id="tbl">
        <thead><tr>
          <th>Nom</th><th>Ann√©e</th><th>Ville</th><th>Pos</th><th>L/R</th>
          <th>Boston</th><th>Meltdown</th><th>Throne</th><th>Conf</th><th>Glisser vers un slot ‚Üí</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Lineups -->
  <section class="card">
    <h2>3) Lineups</h2>
    <div class="grid grid-3">
      <div>
        <div class="slotHeader"><strong>Boston</strong><span class="muted">6 DEF ‚Ä¢ 9 AV/CEN ‚Ä¢ 1 GOL</span></div>
        <div class="slot" id="boston-def"></div>
        <div class="slot" id="boston-fwd" style="margin-top:8px"></div>
        <div class="slot" id="boston-gol" style="margin-top:8px"></div>
      </div>
      <div>
        <div class="slotHeader"><strong>Meltdown</strong><span class="muted">6 ‚Ä¢ 9 ‚Ä¢ 1</span></div>
        <div class="slot" id="meltdown-def"></div>
        <div class="slot" id="meltdown-fwd" style="margin-top:8px"></div>
        <div class="slot" id="meltdown-gol" style="margin-top:8px"></div>
      </div>
      <div>
        <div class="slotHeader"><strong>The Throne</strong><span class="muted">6 ‚Ä¢ 9 ‚Ä¢ 1</span></div>
        <div class="slot" id="throne-def"></div>
        <div class="slot" id="throne-fwd" style="margin-top:8px"></div>
        <div class="slot" id="throne-gol" style="margin-top:8px"></div>
      </div>
    </div>
    <div class="bar" style="margin-top:12px">
      <button class="btn" id="btnAutosuggest">‚ú® Autosuggest</button>
      <button class="btn ghost" id="btnValidate">‚úî V√©rifier quotas</button>
      <span class="muted" id="status"></span>
    </div>
  </section>

  <!-- Previews -->
  <section class="card">
    <h2>4) Pr√©visualisation JSON</h2>
    <details open><summary class="muted">players.json</summary><pre id="pvPlayers" style="white-space:pre-wrap"></pre></details>
    <details><summary class="muted">lineups.json</summary><pre id="pvLineups" style="white-space:pre-wrap"></pre></details>
  </section>
</main>

<script>
/* ====== STATE ====== */
const POS_MAP={Defence:'DEF',Defense:'DEF',Def:'DEF',Forward:'FWD',Avant:'FWD',Center:'CEN',Centre:'CEN',Goaler:'GOL',Goalie:'GOL',Gardien:'GOL'};
const state={players:[], lineups:{boston:{def:[],fwd:[],gol:[],notes:""}, meltdown:{def:[],fwd:[],gol:[],notes:""}, throne:{def:[],fwd:[],gol:[],notes:""}}};
const el=(id)=>document.getElementById(id);

/* ====== PARSE EMAIL BLOCKS ====== */
function slug(s){return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')}
function parseEmails(txt){
  const blocks=txt.trim().split(/\n\s*\n/);
  const out=[];
  for(const block of blocks){
    const lines=block.split(/\r?\n/);
    const o={};
    for(const line of lines){
      const m=line.match(/^([A-Za-z0-9_ ]+)\s+(.+)$/); if(!m) continue;
      const k=m[1].trim().toLowerCase().replace(/\s+/g,'_'), v=m[2].trim(); o[k]=v;
    }
    const p=normalize(o,block); if(p && p.name) out.push(p);
  }
  return out;
}
function normalize(raw,rawTxt){
  const name=raw.player_name||raw.name||''; const by=raw.birth_year?Number(raw.birth_year):null; const id=`${slug(name)}-${by??'xxxx'}`;
  const sides=[]; if((raw.side_left||'').toLowerCase()==='yes')sides.push('L'); if((raw.side_right||'').toLowerCase()==='yes')sides.push('R');
  const prim=POS_MAP[raw.primary_position]||raw.primary_position||''; const sec=POS_MAP[raw.secondary_position]||raw.secondary_position||'NONE';
  function yn(v){const s=(v||'').toUpperCase(); if(['YES','OUI'].includes(s))return 'Yes'; if(['NO','NON'].includes(s))return 'No'; return 'TBD'}
  const p={
    id, name, birth_year:by, city:raw.city||'', current_team:raw.current_team||'',
    parent:{email:raw.parent_email||'', phone:raw.parent_phone||''},
    positions:{primary:(prim||'').toUpperCase(), secondary:(sec||'').toUpperCase()},
    sides, jersey:{type:raw.jersey_type||'', size:raw.jersey_size||'', pref_numbers:[raw.jersey_number_1,raw.jersey_number_2,raw.jersey_number_3].filter(x=>x&&String(x).trim())},
    availability:{boston:yn(raw.boston_showdown), meltdown:yn(raw.montreal_meltdown), throne:yn(raw.the_throne)},
    confidence_pct: raw.confidence_pct?Number(raw.confidence_pct):null,
    consents:{throne_rule:(raw.ack_throne_rule||'').toLowerCase()==='on', limited_spots:(raw.ack_limited_spots||'').toLowerCase()==='on', consent_contact:(raw.consent_contact||'').toLowerCase()==='on'},
    submitted_at: (rawTxt.match(/Submitted at\s+(.+?)\s*\(UTC\)/i)?.[1] ? new Date(RegExp.$1+' UTC').toISOString() : null),
    source: (rawTxt.match(/submitted your form on\s+(https?:\/\/\S+)/i)?.[1]||null)
  };
  return p;
}
function upsert(player){
  const i=state.players.findIndex(x=>x.id===player.id);
  if(i<0){ state.players.push(player); return; }
  const a=state.players[i].submitted_at, b=player.submitted_at;
  if(b && (!a || new Date(b)>new Date(a))) state.players[i]=player;
}

/* ====== RENDER TABLE ====== */
function renderPlayers(){
  const tb=el('tbl').querySelector('tbody'); tb.innerHTML='';
  const q=el('q').value.toLowerCase(), pos=el('fPos').value, fav=el('fAvail').value, fconf=el('fConf').value;
  const rows=state.players.filter(p=>{
    if(q && !(`${p.name} ${p.city}`.toLowerCase().includes(q))) return false;
    if(pos && p.positions && !(p.positions.primary===pos || p.positions.secondary===pos)) return false;
    if(fav){ if((p.availability?.[fav]||'')!=='Yes') return false; }
    if(fconf && (p.confidence_pct||0)<Number(fconf)) return false;
    return true;
  }).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  for(const p of rows){
    const tr=document.createElement('tr');
    const pospill=(r)=>`<span class="pill ${r||''}">${r||''}</span>`;
    tr.innerHTML=`
      <td draggable="true" data-id="${p.id}" class="dr">${p.name}<div class="muted small">${p.parent?.email||''}</div></td>
      <td>${p.birth_year||''}</td>
      <td>${p.city||''}</td>
      <td>${pospill(p.positions?.primary)} ${p.positions?.secondary && p.positions.secondary!=='NONE'? pospill(p.positions.secondary):''}</td>
      <td>${(p.sides||[]).join('/')||'-'}</td>
      <td>${p.availability?.boston||''}</td>
      <td>${p.availability?.meltdown||''}</td>
      <td>${p.availability?.throne||''}</td>
      <td>${p.confidence_pct!=null?p.confidence_pct+'%':''}</td>
      <td class="muted small">Glisser vers un slot</td>`;
    tb.appendChild(tr);
  }
  // DnD source
  tb.querySelectorAll('.dr').forEach(cell=>{
    cell.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain', cell.dataset.id);
      cell.parentElement.classList.add('dnd-drag');
    });
    cell.addEventListener('dragend',e=>cell.parentElement.classList.remove('dnd-drag'));
  });
  updatePreviews();
}

/* ====== LINEUPS ====== */
function renderSlots(){
  const lanes=[['boston','def'],['boston','fwd'],['boston','gol'],['meltdown','def'],['meltdown','fwd'],['meltdown','gol'],['throne','def'],['throne','fwd'],['throne','gol']];
  for(const [t,l] of lanes){
    const host=el(`${t}-${l}`); host.innerHTML='';
    // Drop handlers
    host.ondragover=(e)=>{e.preventDefault(); host.classList.add('drop-ok')};
    host.ondragleave=()=>host.classList.remove('drop-ok');
    host.ondrop=(e)=>{e.preventDefault(); host.classList.remove('drop-ok'); const id=e.dataTransfer.getData('text/plain'); addTo(t,l,id);};
    // chips
    for(const id of state.lineups[t][l]){
      const p=state.players.find(x=>x.id===id);
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML=`<span class="small bold">${p?.name||id}</span><span class="pill ${p?.positions?.primary||''}">${p?.positions?.primary||''}</span><span class="x" title="retirer">‚úï</span>`;
      chip.querySelector('.x').onclick=()=>removeFrom(t,l,id);
      host.appendChild(chip);
    }
  }
  updatePreviews();
}
function addTo(t,l,id){
  if(!id) return;
  const arr=state.lineups[t][l]; if(arr.includes(id)) return;
  const limit=(l==='def')?6:(l==='fwd')?9:1;
  if(arr.length>=limit && !confirm(`${t} ${l.toUpperCase()} d√©passe ${limit}. Ajouter quand m√™me ?`)) return;
  arr.push(id); renderSlots();
}
function removeFrom(t,l,id){
  const arr=state.lineups[t][l]; const i=arr.indexOf(id); if(i>=0) arr.splice(i,1); renderSlots();
}
el('btnValidate').onclick=()=>{
  const msg=[];
  const check=(t,l,lim)=>{ const n=state.lineups[t][l].length; if(n!==lim) msg.push(`${t} ${l.toUpperCase()} ${n}/${lim}`); };
  check('boston','def',6);check('boston','fwd',9);check('boston','gol',1);
  check('meltdown','def',6);check('meltdown','fwd',9);check('meltdown','gol',1);
  check('throne','def',6);check('throne','fwd',9);check('throne','gol',1);
  el('status').textContent = msg.length? '‚ö† ' + msg.join(' | ') : '‚úî Quotas OK';
};
el('btnAutosuggest').onclick=()=>{
  ['boston','meltdown','throne'].forEach(t=>{
    const want={def:6,fwd:9,gol:1};
    for(const lane of ['def','fwd','gol']){
      const arr=state.lineups[t][lane]; const need=Math.max(0,want[lane]-arr.length);
      if(!need) continue;
      const cand=state.players.filter(p=>{
        const okAvail=(p.availability?.[t]||'')==='Yes';
        const okConf=(p.confidence_pct||0)>=80;
        const already = ['def','fwd','gol'].some(L=>state.lineups[t][L].includes(p.id));
        if(!okAvail||!okConf||already) return false;
        if(lane==='def') return p.positions?.primary==='DEF'||p.positions?.secondary==='DEF';
        if(lane==='fwd') return ['FWD','CEN'].includes(p.positions?.primary)||['FWD','CEN'].includes(p.positions?.secondary);
        if(lane==='gol') return p.positions?.primary==='GOL'||p.positions?.secondary==='GOL';
        return false;
      }).slice(0,need);
      arr.push(...cand.map(p=>p.id));
    }
  });
  renderSlots();
};

/* ====== EXPORT ====== */
function updatePreviews(){
  el('pvPlayers').textContent=JSON.stringify({players:state.players},null,2);
  el('pvLineups').textContent=JSON.stringify({version:1,updated_at:new Date().toISOString(),tournaments:state.lineups},null,2);
}
el('btnExportPlayers').onclick=()=>download('players.json', JSON.stringify({players:state.players},null,2));
el('btnExportLineups').onclick=()=>download('lineups.json', JSON.stringify({version:1,updated_at:new Date().toISOString(),tournaments:state.lineups},null,2));
function download(name, text){const blob=new Blob([text],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(url),500);}

/* ====== FILTERS ====== */
['q','fPos','fAvail','fConf'].forEach(id=>el(id).addEventListener('input',renderPlayers));

/* ====== BUTTONS ====== */
el('btnParse').onclick=()=>{
  const src=el('taEmails').value.trim(); if(!src){alert('Colle des emails.');return;}
  const list=parseEmails(src); let n=0; list.forEach(p=>{upsert(p);n++}); renderPlayers(); renderSlots(); updatePreviews(); el('taEmails').value=''; el('status').textContent=`Ajout√©s: ${n}`;
};
el('btnClear').onclick=()=>el('taEmails').value='';
el('btnFetch').onclick=async()=>{
  try{
    const url=el('fetchUrl').value||'data/players.json'; const r=await fetch(url,{cache:'no-store'}); const j=await r.json();
    const arr=Array.isArray(j.players)?j.players:(Array.isArray(j)?j:[]); let n=0; arr.forEach(p=>{upsert(p);n++});
    renderPlayers(); renderSlots(); updatePreviews(); el('status').textContent=`Charg√© depuis ${url}: ${n} joueurs fusionn√©s.`;
  }catch(e){ alert('Impossible de charger le JSON (CORS/URL).'); }
};
/* drag & drop zone for files */
(function(){
  const dz=el('dz');
  function stop(e){e.preventDefault();e.stopPropagation();}
  ['dragenter','dragover','dragleave','drop'].forEach(ev=>dz.addEventListener(ev,stop,false));
  dz.addEventListener('dragover',()=>dz.style.borderColor='rgba(59,130,246,.6)');
  dz.addEventListener('dragleave',()=>dz.style.borderColor='rgba(255,255,255,.18)');
  dz.addEventListener('drop',async (e)=>{
    dz.style.borderColor='rgba(255,255,255,.18)';
    const f=e.dataTransfer.files[0]; if(!f) return;
    const txt=await f.text();
    if(f.name.endsWith('.json')){
      try{ const j=JSON.parse(txt); const arr=Array.isArray(j.players)?j.players:(Array.isArray(j)?j:[]); arr.forEach(p=>upsert(p)); renderPlayers(); renderSlots(); updatePreviews(); }
      catch{ alert('JSON invalide.'); }
    }else{ // CSV basique: header + lignes
      const rows=txt.split(/\r?\n/).filter(Boolean).map(r=>r.split(/,(?![^"]*"[^"]*(?:"[^"]*"[^"]*)*$)/)); // split CSV simple
      const header=rows.shift().map(h=>h.trim().toLowerCase());
      const emails=[];
      for(const r of rows){
        const o={}; r.forEach((v,i)=>o[header[i]]=v.trim());
        // reconstruit un bloc "Name  Value"
        let block=''; for(const k in o){ if(!k) continue; block += `${k}  ${o[k]}\n`; }
        emails.push(block);
      }
      const list=parseEmails(emails.join('\n\n')); list.forEach(p=>upsert(p)); renderPlayers(); renderSlots(); updatePreviews();
    }
  });
})();

/* file input */
el('filePlayers').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return; const txt=await f.text();
  if(f.name.endsWith('.json')){
    try{ const j=JSON.parse(txt); const arr=Array.isArray(j.players)?j.players:(Array.isArray(j)?j:[]); arr.forEach(p=>upsert(p)); renderPlayers(); renderSlots(); updatePreviews(); }
    catch{ alert('JSON invalide.'); }
  }else{
    // CSV
    const rows=txt.split(/\r?\n/).filter(Boolean).map(r=>r.split(/,(?![^"]*"[^"]*(?:"[^"]*"[^"]*)*$)/));
    const header=rows.shift().map(h=>h.trim().toLowerCase());
    const emails=[];
    for(const r of rows){
      const o={}; r.forEach((v,i)=>o[header[i]]=v.trim());
      let block=''; for(const k in o){ if(!k) continue; block += `${k}  ${o[k]}\n`; }
      emails.push(block);
    }
    const list=parseEmails(emails.join('\n\n')); list.forEach(p=>upsert(p)); renderPlayers(); renderSlots(); updatePreviews();
  }
});

/* init */
renderPlayers(); renderSlots(); updatePreviews();
</script>
</body>
</html>
